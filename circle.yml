machine:
    python:
        version: 3.5.2

dependencies:
    pre:
        - sudo apt-get update; sudo apt-get install libgif-dev
        - pip install --upgrade pip
        - npm config set python /usr/bin/python2.7
    post:
        - python setup.py develop

test:
    override:
        - coverage run --source=webtasks setup.py test
        - npm test
    post:
        - flake8 --count --statistics
        - npm run lint
        - npm run coverage
        - codecov --token=22c3c314-f104-4a5c-bb02-0deaca9b79f9
        - mkdir -p $CIRCLE_ARTIFACTS/cover; mv coverage/*  $CIRCLE_ARTIFACTS/cover/

compile:
    override:
        - python setup.py sdist

deployment:
    staging:
        branch: /.*/
        commands:
            - scp -v -o ConnectTimeout=10 dist/webtasks-0.0.tar.gz root@staging.meadows-research.com:/root/
            - cat unpack_install_start.sh | ssh root@staging.meadows-research.com
            - sleep 4; curl -v staging.meadows-research.com
    production:
        branch: master
        commands:
            - scp -v -o ConnectTimeout=10 dist/webtasks-0.0.tar.gz root@meadows-research.com:/root/
            - cat unpack_install_start.sh | ssh root@meadows-research.com
            - sleep 4; curl -v meadows-research.com

general:
    artifacts:
        - "dist"
